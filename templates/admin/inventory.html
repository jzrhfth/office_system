{% extends 'admin/base.html' %}

{% block title %}Inventory - Office Supplies System{% endblock %}

{% block header_title %}Inventory{% endblock %}

{% block header_desc %}Manage office supplies stock{% endblock %}

{% block content %}
    <div class="dashboard-wrapper">
        <!-- Main Content -->
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Inventory Management</h1>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card inventory-card">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value">{{ total_items }}</div>
                    <div class="stat-change positive"></div>
                    <i class="fa-solid fa-boxes-stacked stat-icon-bg icon-blue"></i>
                </div>
                <div class="stat-card inventory-card">
                    <div class="stat-label">In Stock</div>
                    <div class="stat-value">{{ in_stock }}</div>
                    <div class="stat-change positive"></div>
                    <i class="fa-solid fa-check-circle stat-icon-bg icon-green"></i>
                </div>
                <div class="stat-card inventory-card">
                    <div class="stat-label">Low Stock</div>
                    <div class="stat-value">{{ low_stock }}</div>
                    <div class="stat-change negative"></div>
                    <i class="fa-solid fa-triangle-exclamation stat-icon-bg icon-orange"></i>
                </div>
                <div class="stat-card inventory-card">
                    <div class="stat-label">Out of Stock</div>
                    <div class="stat-value">{{ out_of_stock }}</div>
                    <div class="stat-change negative"></div>
                    <i class="fa-solid fa-circle-xmark stat-icon-bg icon-red"></i>
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="tables-grid">
                <div class="table-card">
                    <div class="table-title">
                        <span>All Office Supplies</span>
                        <div style="margin-left: auto; margin-right: 10px; position: relative;">
                            <i class="fa-solid fa-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
                            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Search items..." style="padding: 8px 8px 8px 35px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <a href="#" class="btn-new"><i class="fa-solid fa-plus"></i> Add New Item</a>
                    </div>
                    <table class="styled-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Stock Quantity</th>
                                <th>Unit</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory_items %}
                            <tr>
                                <td>{{ item.item_name }}</td>
                                <td>{{ item.category }}</td>
                                <td>{{ item.stock_quantity }}</td>
                                <td>{{ item.unit }}</td>
                                <td>
                                    {% if item.stock_quantity == 0 %}
                                        <span style="color: #e74c3c; font-weight: 600;">Out of Stock</span>
                                    {% elif item.stock_quantity <= 10 %}
                                        <span style="color: #f39c12; font-weight: 600;">Low Stock</span>
                                    {% else %}
                                        <span style="color: #2ecc71; font-weight: 600;">In Stock</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="#" class="btn-action" title="Edit" 
                                       data-id="{{ item.id }}"
                                       data-name="{{ item.item_name }}"
                                       data-category="{{ item.category }}"
                                       data-qty="{{ item.stock_quantity }}"
                                       data-unit="{{ item.unit or '' }}"
                                       onclick="openEditModal(this)"><i class="fa-regular fa-pen-to-square"></i></a>
                                    <form action="{{ url_for('delete_inventory_item', id=item.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this item?');">
                                        <button type="submit" class="btn-action" title="Delete" style="background:none; border:none; cursor:pointer; color: #e74c3c;"><i class="fa-regular fa-trash-can"></i></button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Item Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Item</h3>
                <button class="modal-close" onclick="closeModal('addModal')"><i class="fa-solid fa-times"></i></button>
            </div>
            <form action="{{ url_for('add_inventory_item') }}" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" name="item_name" placeholder="e.g. A4 Paper Ream" required style="text-transform: capitalize;">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select name="category" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                            <option value="" disabled selected>Select Category</option>
                            <option value="Paper Products">Paper Products</option>
                            <option value="Stationery Supplies">Stationery Supplies</option>
                            <option value="Binders & Organization Tools">Binders & Organization Tools</option>
                            <option value="Printers Supplies">Printers Supplies</option>
                            <option value="Writing Instruments">Writing Instruments</option>
                            <option value="Office Essentials">Office Essentials</option>
                            <option value="Office Paper Products">Office Paper Products</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Quantity</label>
                        <input type="number" name="stock_quantity" placeholder="0" min="0" required>
                    </div>
                    <div class="form-group" >
                        <label >Unit</label>
                        <select name="unit" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                            <option value="" disabled selected >Select Unit</option>
                            <option value="Pcs">Pcs</option>
                            <option value="Box">Box</option>
                            <option value="Ream">Ream</option>
                            <option value="Pack">Pack</option>
                            <option value="Set">Set</option>
                            <option value="Roll">Roll</option>
                            <option value="Bundle">Bundle</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('addModal')">Cancel</button>
                    <button type="submit" class="btn-save">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Item</h3>
                <button class="modal-close" onclick="closeModal('editModal')"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="editItemForm" action="" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="edit_item_name" name="item_name" required style="text-transform: capitalize;">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="edit_category" name="category" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                            <option value="" disabled selected>Select Category</option>
                            <option value="Paper Products">Paper Products</option>
                            <option value="Stationery Supplies">Stationery Supplies</option>
                            <option value="Binders & Organization Tools">Binders & Organization Tools</option>
                            <option value="Printers Supplies">Printers Supplies</option>
                            <option value="Office Essentials">Office Essentials</option>
                            <option value="Writing Instruments">Writing Instruments</option>
                            <option value="Office Paper Products">Office Paper Products</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Quantity</label>
                        <input type="number" id="edit_stock_quantity" name="stock_quantity" min="0" required>
                    </div>
                    <div class="form-group" >
                        <label>Unit</label>
                        <select id="edit_unit" name="unit" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                            <option value="" disabled selected>Select Unit</option>
                            <option value="Pcs">Pcs</option>
                            <option value="Box">Box</option>
                            <option value="Ream">Ream</option>
                            <option value="Pack">Pack</option>
                            <option value="Set">Set</option>
                            <option value="Roll">Roll</option>
                            <option value="Bundle">Bundle</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('editModal')">Cancel</button>
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function searchTable() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("searchInput");
            filter = input.value.toUpperCase();
            table = document.getElementById("inventoryTable");
            tr = table.getElementsByTagName("tr");

            for (i = 1; i < tr.length; i++) {
                // Search in Item Name (index 0) and Category (index 1)
                var tdName = tr[i].getElementsByTagName("td")[0];
                var tdCategory = tr[i].getElementsByTagName("td")[1];
                
                if (tdName && tdCategory) {
                    var txtName = tdName.textContent || tdName.innerText;
                    var txtCategory = tdCategory.textContent || tdCategory.innerText;
                    
                    if (txtName.toUpperCase().indexOf(filter) > -1 || txtCategory.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Open Edit Modal and Populate Data
        function openEditModal(btn) {
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            const category = btn.getAttribute('data-category');
            const qty = btn.getAttribute('data-qty');
            const unit = btn.getAttribute('data-unit');

            document.getElementById('edit_item_name').value = name;
            document.getElementById('edit_category').value = category;
            document.getElementById('edit_stock_quantity').value = qty;
            document.getElementById('edit_unit').value = unit;
            document.getElementById('editItemForm').action = "/inventory/edit/" + id;
            openModal('editModal');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const btnNew = document.querySelector('.btn-new');
            if (btnNew) {
                btnNew.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal('addModal');
                });
            }

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal-overlay')) {
                    event.target.classList.remove('active');
                }
            }
        });
    </script>
{% endblock %}